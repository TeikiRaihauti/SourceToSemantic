<?xml version="1.0" ?>
<ModelUnit modelid=".EPIC Soil Temperature (STEMP_EPIC)" name="EPIC Soil Temperature (STEMP_EPIC)" timestep="1" version="1.0">
	<Description>
		<Title>EPIC Soil Temperature (STEMP_EPIC)</Title>
		<Authors>Kenneth N. Potter; Jimmy R. Williams</Authors>
		<Institution>USDA Agricultural Research Service (USDA-ARS)</Institution>
		<URI>-</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>Daily soil temperature component computing layer temperatures using the EPIC method (Potter &amp; Williams, 1994). It derives a surface temperature signal from air temperature, wet-day frequency, and surface cover (biomass/mulch and snow), estimates damping depth from bulk density and water status, and updates layer temperatures via an exponential depth response with a lag. Integrates with DSSAT-style soil, weather, and management data structures.</ExtendedDescription>
		<ShortDescription>Determines daily soil temperature by layer using the EPIC method with water and cover effects.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="CONTROL_DYNAMIC" description="Dynamic phase flag (2=SEASINIT, 3=RATE)" inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="ISWITCH_ISWWAT" description="'Y' if water simulation enabled, 'N' otherwise" inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="Y" unit="-" uri="-"/>
		<Input name="SOILPROP_BD" description="Bulk density by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="NLAYR" max="-" min="-" default="-" unit="g/cm3" uri="-"/>
		<Input name="SOILPROP_DLAYR" description="Soil layer thickness" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="NLAYR" max="-" min="-" default="-" unit="cm" uri="-"/>
		<Input name="SW" description="Volumetric soil water content by layer" inputtype="variable" variablecategory="exogenous" datatype="DOUBLELIST" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="TAVG" description="Daily average air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMAX" description="Daily maximum air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMIN" description="Daily minimum air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TAV" description="Average annual air temperature" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="WEATHER_RAIN" description="Daily rainfall" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="SOILPROP_DS" description="Cumulative depths to bottom of each layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="NLAYR" max="-" min="-" default="-" unit="cm" uri="-"/>
		<Input name="SOILPROP_DUL" description="Drained upper limit water content by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_LL" description="Lower limit water content by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_NLAYR" description="Number of soil layers" inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="CUMDPT" description="Cumulative soil profile depth" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="DSMID" description="Depth to midpoint of soil layers" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="NLAYR" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="TDL" description="Total water content at DUL over profile" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="TMA" description="5-day memory array for surface temperature" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="5" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="NDays" description="Number of days stored in WetDay memory" inputtype="variable" variablecategory="state" datatype="INT" max="30" min="0" default="-" unit="d" uri="-"/>
		<Input name="WetDay" description="30-day wet-day memory flags" inputtype="variable" variablecategory="state" datatype="INTARRAY" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="X2_PREV" description="Previous surface temperature memory (average of TMA previous step)" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="SRFTEMP" description="Surface temperature" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="ST" description="Soil temperature by layer" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="NLAYR" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="CONTROL_RUN" description="Run number (used for initialization condition)" inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="CONTROL_RNMODE" description="Run mode flag affecting initialization" inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="ORGC_MULCHMASS" description="Mulch mass on soil surface" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="kg/ha" uri="-"/>
		<Input name="WATER_SNOW" description="Snow cover on soil surface" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="MGMT_DEPIR" description="Irrigation depth applied today" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="PLANT_BIOMAS" description="Plant biomass on soil surface" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="kg/ha" uri="-"/>
		<Input name="B" description="Exponential decay factor (Parton and Logan) used in SOILT_EPIC" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="BCV" description="Soil cover fraction combining residue/mulch and snow effects" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="DP" description="Damping depth for soil temperature wave" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="NLAYR" description="Number of soil layers (internal integer used in SOILT_EPIC)" inputtype="variable" variablecategory="auxiliary" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="PESW" description="Potential extractable soil water over profile" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="WFT" description="Fraction of wet days in moving memory window" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="WW" description="Volumetric fraction related to bulk density used in damping computation" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="X2_AVG" description="Average of TMA memory passed to SOILT_EPIC (placeholder, not used)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="0.0" unit="degC" uri="-"/>
		<Input name="WetDay" description="Today's wet-day flag passed to SOILT_EPIC (0/1)" inputtype="variable" variablecategory="auxiliary" datatype="INT" max="1" min="0" default="-" unit="-" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="CUMDPT" description="Cumulative soil profile depth" variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="mm" uri="-"/>
		<Output name="DSMID" description="Depth to midpoint of soil layers" variablecategory="state" datatype="DOUBLELIST" len="NLAYR" max="-" min="0" unit="mm" uri="-"/>
		<Output name="TDL" description="Total water content at DUL over profile" variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="cm" uri="-"/>
		<Output name="TMA" description="5-day memory array for surface temperature" variablecategory="state" datatype="DOUBLELIST" len="5" max="-" min="-" unit="degC" uri="-"/>
		<Output name="NDays" description="Number of days stored in WetDay memory" variablecategory="state" datatype="INT" max="30" min="0" unit="d" uri="-"/>
		<Output name="WetDay" description="30-day wet-day memory flags" variablecategory="state" datatype="INTARRAY" max="1" min="0" unit="-" uri="-"/>
		<Output name="X2_PREV" description="Previous surface temperature memory (average of TMA previous step)" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="SRFTEMP" description="Surface temperature" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ST" description="Soil temperature by layer" variablecategory="state" datatype="DOUBLELIST" len="NLAYR" max="-" min="-" unit="degC" uri="-"/>
	</Outputs>
	<Initialization name="STEMP_EPIC" language="cyml" filename="algo/pyx/STEMP_EPIC.pyx"/>
	<Function name="SOILT_EPIC" description="EPIC soil temperature routine operating on the surface and profile." language="cyml" type="external" filename="algo/pyx/SOILT_EPIC.pyx"/>
	<Function name="compute_profile_sums" description="Internal helper in STEMP_EPIC: computes sums of BD, DUL, LL, and SW across layers." language="cyml" type="external" filename="algo/pyx/compute_profile_sums.pyx"/>
	<Function name="soil_cover_fraction" description="Internal helper in STEMP_EPIC: computes soil cover fraction (BCV) from plant biomass, mulch mass, and snow." language="cyml" type="external" filename="algo/pyx/soil_cover_fraction.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP_EPIC.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_EPIC_basic" description="Runs SEASINIT then one RATE day for a 4-layer soil and checks key state updates.">
			<Param name="SOILPROP_NLAYR">4</Param>
			<Param name="SOILPROP_BD">[1.6, 1.6, 1.6, 1.6]</Param>
			<Param name="SOILPROP_DLAYR">[10.0, 10.0, 10.0, 10.0]</Param>
			<Param name="SOILPROP_DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="SOILPROP_DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="SOILPROP_LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="TAV">20.0</Param>
			<Param name="ISWITCH_ISWWAT">Y</Param>
			<Param name="CONTROL_RUN">1</Param>
			<Param name="CONTROL_RNMODE">B</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_EPIC_basic" description="Runs SEASINIT then one RATE day for a 4-layer soil and checks key state updates." parameterset="p_test_STEMP_EPIC_basic">
			<Test name="t_test_STEMP_EPIC_basic">
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<InputValue name="TMIN">20.0</InputValue>
				<InputValue name="WEATHER_RAIN">0.0</InputValue>
				<InputValue name="ORGC_MULCHMASS">0.0</InputValue>
				<InputValue name="WATER_SNOW">0.0</InputValue>
				<InputValue name="MGMT_DEPIR">0.0</InputValue>
				<InputValue name="PLANT_BIOMAS">0.0</InputValue>
				<InputValue name="CUMDPT">0.0</InputValue>
				<InputValue name="DSMID">[0.0, 0.0, 0.0, 0.0]</InputValue>
				<InputValue name="TDL">0.0</InputValue>
				<InputValue name="TMA">[0.0, 0.0, 0.0, 0.0, 0.0]</InputValue>
				<InputValue name="NDays">0</InputValue>
				<InputValue name="WetDay">[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</InputValue>
				<InputValue name="X2_PREV">0.0</InputValue>
				<InputValue name="SRFTEMP">0.0</InputValue>
				<InputValue name="ST">[0.0, 0.0, 0.0, 0.0]</InputValue>
				<InputValue name="CONTROL_DYNAMIC">2 (init), then 3 (rate)</InputValue>
				<OutputValue name="CUMDPT">400.0 (after init)</OutputValue>
				<OutputValue name="NDays">0 (after init), 1 (after rate)</OutputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
