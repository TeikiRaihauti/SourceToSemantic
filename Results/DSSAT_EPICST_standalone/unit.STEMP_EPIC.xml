<?xml version="1.0" ?>
<ModelUnit modelid=".STEMP_EPIC: EPIC soil temperature module for DSSAT" name="STEMP_EPIC: EPIC soil temperature module for DSSAT" timestep="1" version="1.0">
	<Description>
		<Title>STEMP_EPIC: EPIC soil temperature module for DSSAT</Title>
		<Authors>Kenneth N. Potter; Jimmy R. Williams</Authors>
		<Institution>USDA Agricultural Research Service (USDA-ARS)</Institution>
		<URI>-</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>STEMP_EPIC is a Fortran soil temperature component implementing the EPIC method to compute daily soil temperatures by layer. It derives a damping depth from soil bulk density and water status, uses a 30â€‘day memory of wet days (rain + irrigation) and a soil cover factor (from biomass, mulch, and snow) to adjust surface temperature drivers, and applies empirical relations from Potter &amp; Williams (1994) to estimate an effective surface temperature. Layer temperatures are updated with an exponential damping function and a lag factor, producing daily surface and profile soil temperatures for use by other modules.</ExtendedDescription>
		<ShortDescription>Fortran routine computing daily soil temperature by layer using the EPIC method with wet-day fraction and soil cover effects.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="ISWWAT" description="'Y' if water is simulated; otherwise use drained upper limit for water content." inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="BD" description="Bulk density by soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="g/cm3" uri="-"/>
		<Input name="DLAYR" description="Soil layer thickness." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="cm" uri="-"/>
		<Input name="DS" description="Cumulative depth to bottom of each soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="cm" uri="-"/>
		<Input name="DUL" description="Drained upper limit by layer (volumetric water content)." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="LL" description="Lower limit by layer (volumetric water content)." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="NLAYR" description="Number of soil layers." inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SW" description="Soil water content by layer (volumetric)." inputtype="variable" variablecategory="exogenous" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="TAVG" description="Daily average air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMAX" description="Daily maximum air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMIN" description="Daily minimum air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TAV" description="Long-term average air temperature." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TAMP" description="Air temperature annual amplitude used for reporting." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="RAIN" description="Daily precipitation." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="DEPIR" description="Daily irrigation depth." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="BIOMAS" description="Above-ground biomass." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="kg/ha" uri="-"/>
		<Input name="MULCHMASS" description="Surface mulch/residue mass." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="kg/ha" uri="-"/>
		<Input name="SNOW" description="Snow water equivalent on surface." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="CUMDPT" description="Cumulative soil profile depth from surface (initialized once per season)." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="DSMID" description="Depth to mid-point of each layer from surface (initialized once per season)." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="TDL" description="Accumulated drained upper limit sum (sum(DUL*DLAYR))." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="TMA" description="5-day moving temperature memory." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="NDays" description="Number of days tracked for wetness factor (max 30)." inputtype="variable" variablecategory="state" datatype="INT" max="30" min="0" default="-" unit="-" uri="-"/>
		<Input name="WetDay" description="Rolling 30-day wet day flags (0= dry, 1= wet)." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="30" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="X2_PREV" description="Previous 5-day average surface forcing temperature." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="0.0" unit="degC" uri="-"/>
		<Input name="SRFTEMP" description="Soil surface temperature." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="ST" description="Soil temperature by layer." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="degC" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="SRFTEMP" description="Updated soil surface temperature." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ST" description="Updated soil temperature by layer." variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" unit="degC" uri="-"/>
		<Output name="TMA" description="Updated 5-day temperature memory." variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" unit="degC" uri="-"/>
		<Output name="X2_PREV" description="Updated previous 5-day average surface forcing temperature." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="NDays" description="Updated number of days tracked for wetness factor." variablecategory="state" datatype="INT" max="30" min="0" unit="-" uri="-"/>
		<Output name="WetDay" description="Updated 30-day wet day flags." variablecategory="state" datatype="DOUBLEARRAY" len="30" max="1" min="0" unit="-" uri="-"/>
		<Output name="TDL" description="Accumulated drained upper limit sum after update." variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="cm" uri="-"/>
		<Output name="CUMDPT" description="Cumulative soil profile depth (set at initialization)." variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="mm" uri="-"/>
		<Output name="DSMID" description="Depth to mid-point of each layer (set at initialization)." variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="0" unit="mm" uri="-"/>
	</Outputs>
	<Initialization name="STEMP_EPIC" language="cyml" filename="algo/pyx/STEMP_EPIC.pyx"/>
	<Function name="SOILT_EPIC" description="Core EPIC soil temperature routine; computes surface and layer temperatures considering wet-day memory and surface cover; updates TMA, SRFTEMP, ST, and X2_PREV." language="cyml" type="external" filename="algo/pyx/SOILT_EPIC.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP_EPIC.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_EPIC_basic" description="Initializes model and executes daily updates; verifies array lengths.">
			<Param name="ISWWAT">Y</Param>
			<Param name="NLAYR">4</Param>
			<Param name="BD">[1.6, 1.6, 1.6, 1.6]</Param>
			<Param name="DLAYR">[10.0, 10.0, 10.0, 10.0]</Param>
			<Param name="DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="TAV">20.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_EPIC_basic" description="Initializes model and executes daily updates; verifies array lengths." parameterset="p_test_STEMP_EPIC_basic">
			<Test name="t_test_STEMP_EPIC_basic">
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<InputValue name="TMIN">20.0</InputValue>
				<InputValue name="TAMP">12.0</InputValue>
				<InputValue name="RAIN">0.0</InputValue>
				<InputValue name="DEPIR">0.0</InputValue>
				<InputValue name="BIOMAS">0.0</InputValue>
				<InputValue name="MULCHMASS">0.0</InputValue>
				<InputValue name="SNOW">0.0</InputValue>
				<InputValue name="X2_PREV">0.0</InputValue>
				<OutputValue name="DSMID">len==4</OutputValue>
				<OutputValue name="TMA">len==5</OutputValue>
				<OutputValue name="WetDay">len==30</OutputValue>
				<OutputValue name="ST">len==4</OutputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
