<?xml version="1.0" ?>
<ModelUnit modelid=".STEMP (Soil temperature by layer)" name="STEMP (Soil temperature by layer)" timestep="1" version="1.0">
	<Description>
		<Title>STEMP (Soil temperature by layer)</Title>
		<Authors>DSSAT (DSSAT Florida); C.H. Porter</Authors>
		<Institution>The University of Georgia, Griffin, Georgia; University of Florida, Gainesville, Florida; Iowa State University, Ames, Iowa; International Center for Soil Fertility and Agricultural Development (IFDC), Muscle Shoals, Alabama; University of Guelph, Guelph, Ontario</Institution>
		<URI>-</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>Daily soil temperature component that computes surface and layer temperatures using a sinusoidal forcing based on annual mean (TAV) and amplitude (TAMP), with damping depth derived from soil bulk density, albedo, and water content (via potential extractable soil water). The formulation follows the Partonâ€“Logan approach, adjusts for hemisphere-specific hottest day, and can operate with or without dynamic soil water (ISWWAT). Outputs include surface temperature and temperatures by soil layer.</ExtendedDescription>
		<ShortDescription>Determines soil temperature by layer.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="CONTROL_DYNAMIC" description="Simulation phase control flag (e.g., 2=SEASINIT, 3=RATE)." inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="CONTROL_YRDOY" description="Date in YYYYDDD used to compute day-of-year." inputtype="variable" variablecategory="exogenous" datatype="INT" max="9999366" min="1000001" default="-" unit="-" uri="-"/>
		<Input name="ISWITCH_ISWWAT" description="Water switch (Y uses actual soil water, otherwise uses DUL)." inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="Y" unit="-" uri="-"/>
		<Input name="SOILPROP_BD" description="Bulk density by soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_DLAYR" description="Layer thickness by soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_DS" description="Cumulative depth to bottom of each layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_DUL" description="Drained upper limit by soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_LL" description="Lower limit (LL) by soil layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_NLAYR" description="Number of soil layers." inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_MSALB" description="Bare soil surface albedo." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="1.0" min="0.0" default="-" unit="-" uri="-"/>
		<Input name="SRAD" description="Daily solar radiation." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0.0" default="-" unit="-" uri="-"/>
		<Input name="SW" description="Soil water content by layer." inputtype="variable" variablecategory="exogenous" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="0.0" default="-" unit="-" uri="-"/>
		<Input name="TAVG" description="Daily average air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMAX" description="Daily maximum air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="XLAT" description="Latitude used to set seasonal heat day (HDAY)." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="90.0" min="-90.0" default="-" unit="degrees" uri="-"/>
		<Input name="TAV" description="Long-term average annual air temperature." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TAMP" description="Amplitude of annual temperature variation." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="0.0" default="-" unit="degC" uri="-"/>
		<Input name="CUMDPT" description="Cumulative damping depth or depth-related state used in temperature calculations." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="0.0" unit="-" uri="-"/>
		<Input name="DSMID" description="Depth to midpoint of each soil layer." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="[]" unit="-" uri="-"/>
		<Input name="TDL" description="Profile total at drained upper limit (sum over layers)." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0.0" default="0.0" unit="-" uri="-"/>
		<Input name="TMA" description="5-day moving average air temperatures used for soil temperature computation." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" default="[0,0,0,0,0]" unit="degC" uri="-"/>
		<Input name="ATOT" description="Sum of TMA values over the last 5 days." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="0.0" unit="degC*day" uri="-"/>
		<Input name="SRFTEMP" description="Surface soil temperature." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="0.0" unit="degC" uri="-"/>
		<Input name="ST" description="Soil temperature by layer." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="[]" unit="degC" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="CUMDPT" description="Updated cumulative depth-related state for temperature damping." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="-" uri="-"/>
		<Output name="DSMID" description="Updated depth to midpoint of each soil layer." variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" unit="-" uri="-"/>
		<Output name="TDL" description="Updated profile total at drained upper limit." variablecategory="state" datatype="DOUBLE" max="-" min="0.0" unit="-" uri="-"/>
		<Output name="TMA" description="Updated 5-day moving average temperatures." variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ATOT" description="Updated 5-day temperature sum." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC*day" uri="-"/>
		<Output name="SRFTEMP" description="Updated surface soil temperature." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ST" description="Updated soil temperature profile by layer." variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" unit="degC" uri="-"/>
	</Outputs>
	<Initialization name="STEMP" language="cyml" filename="algo/pyx/STEMP.pyx"/>
	<Function name="YR_DOY" description="Converts YRDOY (YYYYDDD) into (YEAR, DOY)." language="cyml" type="external" filename="algo/pyx/YR_DOY.pyx"/>
	<Function name="_fortran_nint" description="Fortran-style NINT rounding: nearest integer with halves away from zero." language="cyml" type="external" filename="algo/pyx/_fortran_nint.pyx"/>
	<Function name="_fortran_round" description="Rounds a float to given decimals using Fortran NINT semantics." language="cyml" type="external" filename="algo/pyx/_fortran_round.pyx"/>
	<Function name="SOILT" description="Computes soil temperature profile and surface temperature using soil properties, climate, and moisture; updates TMA and ATOT." language="cyml" type="external" filename="algo/pyx/SOILT.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_basic_from_ASKEE" description="Initializes STEMP (SEASINIT) and runs one RATE step, returning states for inspection.">
			<Param name="ISWITCH_ISWWAT">Y</Param>
			<Param name="SOILPROP_NLAYR">4</Param>
			<Param name="SOILPROP_BD">[1.6, 1.6, 1.6, 1.6]</Param>
			<Param name="SOILPROP_DLAYR">[10.0, 10.0, 10.0, 10.0]</Param>
			<Param name="SOILPROP_DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="SOILPROP_DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="SOILPROP_LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="SOILPROP_MSALB">0.13</Param>
			<Param name="XLAT">28.0</Param>
			<Param name="TAV">20.0</Param>
			<Param name="TAMP">10.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_basic_from_ASKEE" description="Initializes STEMP (SEASINIT) and runs one RATE step, returning states for inspection." parameterset="p_test_STEMP_basic_from_ASKEE">
			<Test name="t_test_STEMP_basic_from_ASKEE">
				<InputValue name="CONTROL_DYNAMIC">2</InputValue>
				<InputValue name="CONTROL_YRDOY">2021100</InputValue>
				<InputValue name="SRAD">20.0</InputValue>
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<InputValue name="CUMDPT">0.0</InputValue>
				<InputValue name="DSMID">[0.0, 0.0, 0.0, 0.0]</InputValue>
				<InputValue name="TDL">0.0</InputValue>
				<InputValue name="TMA">[0.0, 0.0, 0.0, 0.0, 0.0]</InputValue>
				<InputValue name="ATOT">0.0</InputValue>
				<InputValue name="SRFTEMP">0.0</InputValue>
				<InputValue name="ST">[0.0, 0.0, 0.0, 0.0]</InputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
