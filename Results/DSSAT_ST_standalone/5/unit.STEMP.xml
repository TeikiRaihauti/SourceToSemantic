<?xml version="1.0" ?>
<ModelUnit modelid=".STEMP – Soil Temperature by Layer" name="STEMP – Soil Temperature by Layer" timestep="1" version="1.0">
	<Description>
		<Title>STEMP – Soil Temperature by Layer</Title>
		<Authors>DSSAT (DSSAT Florida); C.H. Porter</Authors>
		<Institution>The University of Georgia, Griffin, Georgia; University of Florida, Gainesville, Florida; Iowa State University, Ames, Iowa; International Center for Soil Fertility and Agricultural Development, Muscle Shoals, Alabama; University of Guelph, Guelph, Ontario</Institution>
		<URI>-</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>Computes daily soil temperature for each soil layer using annual mean soil temperature (TAV), temperature amplitude (TAMP), solar radiation, soil albedo (including mulch and soil-water effects), bulk density, and water content to derive damping depth and propagate a sinusoidal temperature wave following EPIC/Parton–Logan concepts. Also estimates a surface litter temperature and provides seasonal initialization and daily updates within DSSAT.</ExtendedDescription>
		<ShortDescription>Determines soil temperature by layer.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="ISWITCH_ISWWAT" description="Water balance switch: 'Y' uses actual soil water (SW), 'N' uses DUL for PESW" inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_BD" description="Bulk density by soil layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="g/cm3" uri="-"/>
		<Input name="SOILPROP_DLAYR" description="Thickness of each soil layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="SOILPROP_DS" description="Depth to bottom of soil layers (cumulative)" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="SOILPROP_DUL" description="Drained upper limit (volumetric water content) by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_LL" description="Lower limit (volumetric water content) by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_NLAYR" description="Number of soil layers" inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_MSALB" description="Soil albedo for bare soil" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="SRAD" description="Daily solar radiation (passed through; not used in computations)" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="MJ/m2/day" uri="-"/>
		<Input name="SW" description="Soil water content by layer" inputtype="variable" variablecategory="exogenous" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="TAVG" description="Daily average air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="C" uri="-"/>
		<Input name="TMAX" description="Daily maximum air temperature (passed through; not used in calculations)" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="C" uri="-"/>
		<Input name="XLAT" description="Latitude" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="90" min="-90" default="-" unit="deg" uri="-"/>
		<Input name="TAV" description="Mean annual air temperature" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="C" uri="-"/>
		<Input name="TAMP" description="Annual temperature amplitude" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="0" default="-" unit="C" uri="-"/>
		<Input name="DOY" description="Day of year" inputtype="variable" variablecategory="exogenous" datatype="INT" max="366" min="1" default="-" unit="day-of-year" uri="-"/>
		<Input name="HDAY" description="Hottest day-of-year index derived from latitude (southern hemisphere: 20, northern: 200)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="366" min="1" default="-" unit="day-of-year" uri="-"/>
		<Input name="CUMDPT" description="Cumulative soil profile depth used for thermal damping computations" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="DSMID" description="Depth to midpoint of each soil layer" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="TDL" description="Total water at drained upper limit integrated over soil profile" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri="-"/>
		<Input name="TMA" description="Memory of previous 5 days' average air temperatures (most recent at index 0)" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="5" max="-" min="-" default="-" unit="C" uri="-"/>
		<Input name="ATOT" description="Sum of the 5-day temperature memory (TMA)" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="C" uri="-"/>
		<Input name="NLAYR" description="Number of soil layers (alias used internally and passed to SOILT)" inputtype="variable" variablecategory="auxiliary" datatype="INT" max="-" min="1" default="-" unit="-" uri="-"/>
		<Input name="ALBEDO" description="Albedo passed to SOILT (from SOILPROP_MSALB)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="B" description="Soil thermal damping shape parameter (log(500/DP))" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="DP" description="Damping depth of temperature wave" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri="-"/>
		<Input name="WW" description="Soil water weighting factor derived from apparent bulk density" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="PESW" description="Plant extractable soil water used in damping (computed from SW/DUL and LL)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="CUMDPT" description="Cumulative soil profile depth carried forward" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="mm" uri="-"/>
		<Output name="DSMID" description="Midpoint depth of each soil layer carried forward" variablecategory="state" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="-" unit="mm" uri="-"/>
		<Output name="TDL" description="Updated total drained upper limit over the soil profile" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="cm" uri="-"/>
		<Output name="TMA" description="Updated 5-day temperature memory" variablecategory="state" datatype="DOUBLELIST" len="5" max="-" min="-" unit="C" uri="-"/>
		<Output name="ATOT" description="Updated sum of the 5-day temperature memory" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="C" uri="-"/>
		<Output name="SRFTEMP" description="Surface litter temperature" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="C" uri="-"/>
		<Output name="ST" description="Soil temperature by layer" variablecategory="state" datatype="DOUBLELIST" len="SOILPROP_NLAYR" max="-" min="-" unit="C" uri="-"/>
	</Outputs>
	<Initialization name="STEMP_Initialize" language="cyml" filename="algo/pyx/STEMP_Initialize.pyx"/>
	<Function name="fortran_nint" description="Fortran-compatible nearest-integer rounding with ties away from zero." language="cyml" type="external" filename="algo/pyx/fortran_nint.pyx"/>
	<Function name="SOILT" description="Computes surface and layer soil temperatures using EPIC damping; updates TMA and ATOT." language="cyml" type="external" filename="algo/pyx/SOILT.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_basic" description="Exercises STEMP_Initialize and STEMP once and checks types/lengths (no numeric assertions).">
			<Param name="ISWITCH_ISWWAT">Y</Param>
			<Param name="SOILPROP_BD">[1.6, 1.6, 1.6, 1.6]</Param>
			<Param name="SOILPROP_DLAYR">[10.0, 10.0, 10.0, 10.0]</Param>
			<Param name="SOILPROP_DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="SOILPROP_DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="SOILPROP_LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="SOILPROP_NLAYR">4</Param>
			<Param name="SOILPROP_MSALB">0.13</Param>
			<Param name="XLAT">28.0</Param>
			<Param name="TAV">20.0</Param>
			<Param name="TAMP">10.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_basic" description="Exercises STEMP_Initialize and STEMP once and checks types/lengths (no numeric assertions)." parameterset="p_test_STEMP_basic">
			<Test name="t_test_STEMP_basic">
				<InputValue name="SRAD">20.0</InputValue>
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<InputValue name="DOY">100</InputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
