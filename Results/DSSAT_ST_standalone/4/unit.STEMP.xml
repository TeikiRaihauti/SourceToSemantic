<?xml version="1.0" ?>
<ModelUnit modelid=".STEMP - Soil temperature by layer" name="STEMP - Soil temperature by layer" timestep="1" version="1.0">
	<Description>
		<Title>STEMP - Soil temperature by layer</Title>
		<Authors>DSSAT (DSSAT Florida); C.H. Porter</Authors>
		<Institution>The University of Georgia; University of Florida; Iowa State University; International Center for Soil Fertility and Agricultural Development; University of Guelph</Institution>
		<URI>-</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>Daily soil temperature component that computes the temperature profile by soil layer and a surface litter temperature using an EPIC/Parton-Logan damping-depth approach. It uses climate normals (TAV, TAMP), daily weather (TAVG, TMAX, SRAD), latitude, soil albedo (MSALB), bulk density, layer depths, and soil water status to update ST(L) and SRFTEMP, maintaining a 5-day moving mean.</ExtendedDescription>
		<ShortDescription>Determines soil temperature by layer.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="CONTROL_YRDOY" description="Combined year and day-of-year as YYYY*1000 + DOY" inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri=""/>
		<Input name="ISWITCH_ISWWAT" description="Switch to use water balance (Y) or not (N) for plant-extractable soil water (PESW)" inputtype="parameter" parametercategory="constant" datatype="CHAR" max="-" min="-" default="-" unit="-" uri=""/>
		<Input name="SOILPROP_BD" description="Soil bulk density by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="g cm-3" uri=""/>
		<Input name="SOILPROP_DLAYR" description="Soil layer thickness by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="cm" uri=""/>
		<Input name="SOILPROP_DS" description="Depth to bottom of each soil layer (cumulative)" inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" default="-" unit="cm" uri=""/>
		<Input name="SOILPROP_DUL" description="Volumetric water content at drained upper limit by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3 cm-3" uri=""/>
		<Input name="SOILPROP_LL" description="Volumetric water content at lower limit by layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3 cm-3" uri=""/>
		<Input name="SOILPROP_NLAYR" description="Number of soil layers" inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="1" default="-" unit="-" uri=""/>
		<Input name="SOILPROP_MSALB" description="Minimum soil albedo (fraction)" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri=""/>
		<Input name="SRAD" description="Daily solar radiation" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri=""/>
		<Input name="SW" description="Soil water content by layer (can be scalar or per layer)" inputtype="variable" variablecategory="exogenous" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="1" min="0" default="-" unit="cm3 cm-3" uri=""/>
		<Input name="TAVG" description="Daily average air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri=""/>
		<Input name="TMAX" description="Daily maximum air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri=""/>
		<Input name="XLAT" description="Latitude" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="90" min="-90" default="-" unit="degrees" uri=""/>
		<Input name="TAV" description="Mean annual air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri=""/>
		<Input name="TAMP" description="Annual amplitude of air temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="0" default="-" unit="degC" uri=""/>
		<Input name="HDAY" description="Hemisphere day offset (seasonal phase shift)" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="day-of-year" uri=""/>
		<Input name="CUMDPT" description="Cumulative soil profile depth" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri=""/>
		<Input name="DSMID" description="Depth to midpoint of each soil layer" inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="0" default="-" unit="mm" uri=""/>
		<Input name="TMA" description="Rolling memory of the last 5 daily average temperatures" inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" default="-" unit="degC" uri=""/>
		<Input name="ATOT" description="Sum of rolling memory temperatures (TMA)" inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri=""/>
		<Input name="YRDOY" description="Year-day composite used by YR_DOY" inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri=""/>
		<Input name="DOY" description="Day of year (1-366) derived from YRDOY" inputtype="variable" variablecategory="auxiliary" datatype="INT" max="366" min="1" default="-" unit="-" uri=""/>
		<Input name="ALBEDO" description="Soil albedo passed to SOILT (set from MSALB)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri=""/>
		<Input name="B" description="Damping coefficient for thermal wave" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri=""/>
		<Input name="DP" description="Damping depth for temperature wave" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="mm" uri=""/>
		<Input name="NLAYR" description="Number of layers as used within SOILT" inputtype="variable" variablecategory="auxiliary" datatype="INT" max="-" min="1" default="-" unit="-" uri=""/>
		<Input name="PESW" description="Plant-extractable soil water in profile" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="0" default="-" unit="cm" uri=""/>
		<Input name="WW" description="Affecting soil heat capacity term (texture-dependent factor)" inputtype="variable" variablecategory="auxiliary" datatype="DOUBLE" max="-" min="-" default="-" unit="-" uri=""/>
	</Inputs>
	<Outputs>
		<Output name="CUMDPT" description="Cumulative soil profile depth (carried forward)" variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="mm" uri=""/>
		<Output name="DSMID" description="Depth to the midpoint of each soil layer (carried forward)" variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="0" unit="mm" uri=""/>
		<Output name="TDL_local" description="Profile water at drained upper limit (sum over layers)" variablecategory="state" datatype="DOUBLE" max="-" min="0" unit="cm" uri=""/>
		<Output name="TMA_new" description="Updated 5-day rolling memory of average air temperature" variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" unit="degC" uri=""/>
		<Output name="ATOT_new" description="Updated sum of rolling memory temperatures (TMA)" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri=""/>
		<Output name="SRFTEMP" description="Computed surface soil temperature" variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri=""/>
		<Output name="ST" description="Computed soil temperature by layer" variablecategory="state" datatype="DOUBLEARRAY" len="SOILPROP_NLAYR" max="-" min="-" unit="degC" uri=""/>
	</Outputs>
	<Initialization name="STEMP_Initialize" language="cyml" filename="algo/pyx/STEMP_Initialize.pyx"/>
	<Function name="_nint" description="Nearest-integer rounding returning float." language="cyml" type="external" filename="algo/pyx/_nint.pyx"/>
	<Function name="YR_DOY" description="Split composite YRDOY into year and day-of-year." language="cyml" type="external" filename="algo/pyx/YR_DOY.pyx"/>
	<Function name="SOILT" description="Compute surface and layered soil temperatures using EPIC method and rolling temperature memory." language="cyml" type="external" filename="algo/pyx/SOILT.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_example" description="Initialization and one-step run; checks shapes and invariants.">
			<Param name="ISWITCH_ISWWAT">Y</Param>
			<Param name="SOILPROP_BD">[1.6, 1.6, 1.6, 1.6]</Param>
			<Param name="SOILPROP_DLAYR">[10.0, 10.0, 10.0, 10.0]</Param>
			<Param name="SOILPROP_DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="SOILPROP_DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="SOILPROP_LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="SOILPROP_NLAYR">4</Param>
			<Param name="SOILPROP_MSALB">0.13</Param>
			<Param name="XLAT">28.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_example" description="Initialization and one-step run; checks shapes and invariants." parameterset="p_test_STEMP_example">
			<Test name="t_test_STEMP_example">
				<InputValue name="CONTROL_YRDOY">2021100</InputValue>
				<InputValue name="NLAYR">4</InputValue>
				<InputValue name="SRAD">20.0</InputValue>
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<InputValue name="TAV">20.0</InputValue>
				<InputValue name="TAMP">10.0</InputValue>
				<OutputValue name="DSMID_length">4</OutputValue>
				<OutputValue name="ST_length">4</OutputValue>
				<OutputValue name="TMA_length">5</OutputValue>
				<OutputValue name="CUMDPT2_equals_CUMDPT">True</OutputValue>
				<OutputValue name="DSMID2_equals_DSMID">True</OutputValue>
				<OutputValue name="ST2_length">4</OutputValue>
				<OutputValue name="TMA2_length">5</OutputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
