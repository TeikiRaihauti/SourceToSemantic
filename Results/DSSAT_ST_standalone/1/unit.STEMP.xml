<?xml version="1.0" ?>
<ModelUnit modelid=".STEMP – Soil temperature by layer (DSSAT component)" name="STEMP – Soil temperature by layer (DSSAT component)" timestep="1" version="1.0">
	<Description>
		<Title>STEMP – Soil temperature by layer (DSSAT component)</Title>
		<Authors>DSSAT Development Team; C.H. Porter; Gerrit Hoogenboom; A.J. Gijsman; P.W. Wilkens</Authors>
		<Institution>University of Georgia; University of Florida; Iowa State University; International Center for Soil Fertility and Agricultural Development (IFDC); University of Guelph</Institution>
		<URI>https://github.com/DSSAT/dssat-csm-os</URI>
		<Reference>https://doi.org/10.2134/agronj1994.00021962008600060014x</Reference>
		<ExtendedDescription>STEMP computes daily soil temperature by layer within DSSAT/CSM using EPIC-inspired damping-depth physics and a sinusoidal seasonal forcing. It initializes layer midpoints and cumulative depth, derives bulk density and an effective water content function WC = max(0.01, PESW)/(WW*CUMDPT)*10, computes a damping depth DD = FX*DP with FX = exp(B*((1−WC)/(1+WC))^2), and updates temperatures as ST(L) = TAV + (TAMP/2*cos(ALX + ZD) + DT)*exp(ZD), where ALX is the seasonal phase, ZD = −DSMID(L)/DD, DT is the deviation of recent mean air temperature from the seasonal signal, and TAV/TAMP are long-term mean and amplitude. Surface temperature is calculated similarly. Inputs include radiation, air temperatures, latitude, soil water (or DUL if water is off), albedo (including mulch), and soil properties by layer. Output is daily surface and layer temperatures.</ExtendedDescription>
		<ShortDescription>Daily 1D soil thermal profile model computing surface and layered soil temperatures from weather, soil, and water inputs within DSSAT.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="CONTROL_DYNAMIC" description="Dynamic phase selector (2=SEASINIT, 3=RATE)." inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="CONTROL_YRDOY" description="Composite year-day-of-year code (e.g., 2024123)." inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="YYYYDOY" uri="-"/>
		<Input name="CONTROL_RUN" description="Run number." inputtype="variable" variablecategory="exogenous" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="CONTROL_RNMODE" description="Run mode flag." inputtype="variable" variablecategory="exogenous" datatype="CHAR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="ISWITCH_ISWWAT" description="Water simulation switch ('Y' or 'N')." inputtype="variable" variablecategory="exogenous" datatype="CHAR" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_BD" description="Bulk density by layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="g/cm3" uri="-"/>
		<Input name="SOILPROP_DLAYR" description="Layer thickness by layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="mm" uri="-"/>
		<Input name="SOILPROP_DS" description="Depth to bottom of each layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="cm" uri="-"/>
		<Input name="SOILPROP_DUL" description="Drained upper limit (volumetric) by layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_LL" description="Lower limit (volumetric) by layer." inputtype="parameter" parametercategory="constant" datatype="DOUBLEARRAY" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="SOILPROP_NLAYR" description="Number of soil layers." inputtype="parameter" parametercategory="constant" datatype="INT" max="-" min="-" default="-" unit="-" uri="-"/>
		<Input name="SOILPROP_MSALB" description="Soil/mulch albedo." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="SRAD" description="Daily solar radiation." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="MJ/m2-d" uri="-"/>
		<Input name="SW" description="Soil water content (volumetric) by layer." inputtype="variable" variablecategory="exogenous" datatype="DOUBLEARRAY" len="NLAYR" max="1" min="0" default="-" unit="cm3/cm3" uri="-"/>
		<Input name="TAVG" description="Average air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TMAX" description="Maximum air temperature." inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="XLAT" description="Latitude." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="deg" uri="-"/>
		<Input name="TAV" description="Annual average air temperature." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="TAMP" description="Annual amplitude of air temperature." inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="CUMDPT" description="Cumulative profile depth." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="mm" uri="-"/>
		<Input name="DSMID" description="Depth to midpoint of each layer." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="mm" uri="-"/>
		<Input name="TDL" description="Sum of DUL*thickness across profile." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="mm" uri="-"/>
		<Input name="TMA" description="5-day moving average queue (most recent first)." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="ATOT" description="Sum of TMA elements." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="SRFTEMP" description="Surface temperature." inputtype="variable" variablecategory="state" datatype="DOUBLE" max="-" min="-" default="-" unit="degC" uri="-"/>
		<Input name="ST" description="Soil temperature by layer." inputtype="variable" variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" default="-" unit="degC" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="CUMDPT" description="Cumulative profile depth (possibly updated at SEASINIT)." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="mm" uri="-"/>
		<Output name="DSMID" description="Depth to midpoint of each layer (possibly updated at SEASINIT)." variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" unit="mm" uri="-"/>
		<Output name="TDL" description="Sum of DUL*thickness across profile (updated)." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="mm" uri="-"/>
		<Output name="TMA" description="5-day moving average queue (updated)." variablecategory="state" datatype="DOUBLEARRAY" len="5" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ATOT" description="Sum of TMA elements (updated)." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="SRFTEMP" description="Surface temperature (updated)." variablecategory="state" datatype="DOUBLE" max="-" min="-" unit="degC" uri="-"/>
		<Output name="ST" description="Soil temperature by layer (updated)." variablecategory="state" datatype="DOUBLEARRAY" len="NLAYR" max="-" min="-" unit="degC" uri="-"/>
	</Outputs>
	<Initialization name="STEMP" language="cyml" filename="algo/pyx/STEMP.pyx"/>
	<Function name="_nint" description="Nearest-integer rounding (halves away from zero)." language="cyml" type="external" filename="algo/pyx/_nint.pyx"/>
	<Function name="_round_nint" description="Rounding to specified decimals using Fortran-like NINT." language="cyml" type="external" filename="algo/pyx/_round_nint.pyx"/>
	<Function name="YR_DOY" description="Computes (YEAR, DOY) from an integer YRDOY code." language="cyml" type="external" filename="algo/pyx/YR_DOY.pyx"/>
	<Function name="SOILT" description="Computes soil temperature by layer and surface temperature; updates 5-day moving average (TMA) and its sum (ATOT)." language="cyml" type="external" filename="algo/pyx/SOILT.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STEMP.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STEMP_basic" description="Basic smoke test ensuring STEMP runs without errors for SEASINIT and RATE.">
			<Param name="SOILPROP_BD">[1.6, 1.5, 1.4, 1.3]</Param>
			<Param name="SOILPROP_DLAYR">[100.0, 100.0, 100.0, 100.0]</Param>
			<Param name="SOILPROP_DS">[10.0, 20.0, 30.0, 40.0]</Param>
			<Param name="SOILPROP_DUL">[0.3, 0.3, 0.3, 0.3]</Param>
			<Param name="SOILPROP_LL">[0.2, 0.2, 0.2, 0.2]</Param>
			<Param name="SOILPROP_NLAYR">4</Param>
			<Param name="SOILPROP_MSALB">0.13</Param>
			<Param name="XLAT">28.0</Param>
			<Param name="TAV">20.0</Param>
			<Param name="TAMP">10.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STEMP_basic" description="Basic smoke test ensuring STEMP runs without errors for SEASINIT and RATE." parameterset="p_test_STEMP_basic">
			<Test name="t_test_STEMP_basic">
				<InputValue name="CONTROL_YRDOY">2021100</InputValue>
				<InputValue name="CONTROL_RUN">1</InputValue>
				<InputValue name="CONTROL_RNMODE">B</InputValue>
				<InputValue name="ISWITCH_ISWWAT">Y</InputValue>
				<InputValue name="SRAD">20.0</InputValue>
				<InputValue name="SW">[0.2, 0.2, 0.2, 0.2]</InputValue>
				<InputValue name="TAVG">25.0</InputValue>
				<InputValue name="TMAX">30.0</InputValue>
				<OutputValue name="-">-</OutputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
