<?xml version="1.0" ?>
<ModelUnit modelid=".STMP Soil Temperature (SIMPLACE STMPsimCalculator)" name="STMP Soil Temperature (SIMPLACE STMPsimCalculator)" timestep="1" version="-">
	<Description>
		<Title>STMP Soil Temperature (SIMPLACE STMPsimCalculator)</Title>
		<Authors>Andreas Enders; Gunther Krauss</Authors>
		<Institution>Crop Science Group, University of Bonn, Germany</Institution>
		<URI>http://www.simplace.net</URI>
		<Reference>-</Reference>
		<ExtendedDescription>STMPsimCalculator is a SIMPLACE component that simulates daily soil temperature by layer using the APEX-based STMP formulation. It updates each layer’s temperature via a lagged combination of the previous day and a depth-weighted approach: STMP = LAG * STMP0 + (1−LAG) * (FZ * (AVT − DST0) + DST0), where FZ depends on layer midpoint depth relative to a dynamically computed damping depth (DD). DD is estimated from average soil bulk density (ABD) and soil water content, following APEX equations. The surface temperature (DST0) is provided by the coupled SnowCoverCalculator, which accounts for residue/snow insulation. Initialization linearly interpolates temperatures from a first-day mean air temperature at the surface to the long-term average air temperature (AVT) at the damping depth, adding virtual layers down to DD. Reference: Williams &amp; Izaurralde (2005), The APEX model.</ExtendedDescription>
		<ShortDescription>APEX-based multi-layer soil temperature module for SIMPLACE, using damping depth and surface temperature (with snow/residue effects) to update daily temperatures by depth.</ShortDescription>
	</Description>
	<Inputs>
		<Input name="cSoilLayerDepth" description="Original depth to the bottom of each soil layer" inputtype="parameter" parametercategory="constant" datatype="DOUBLELIST" len="-" max="-" min="-" default="-" unit="m" uri="-"/>
		<Input name="cFirstDayMeanTemp" description="Mean air temperature on first day for initialization" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="°C" uri="-"/>
		<Input name="cDampingDepth" description="Damping depth used for initialization" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="m" uri="-"/>
		<Input name="cAVT" description="Long-term average annual air temperature" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="°C" uri="-"/>
		<Input name="iDoInitialize" description="If 1 (True), re-initialize state before processing" inputtype="variable" variablecategory="exogenous" datatype="INT" max="1" min="0" default="-" unit="-" uri="-"/>
		<Input name="iSoilWaterContent" description="Water content of the whole soil profile" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="mm" uri="-"/>
		<Input name="iSoilSurfaceTemperature" description="Soil surface temperature" inputtype="variable" variablecategory="exogenous" datatype="DOUBLE" max="-" min="-" default="-" unit="°C" uri="-"/>
		<Input name="cABD" description="Average soil bulk density of the profile" inputtype="parameter" parametercategory="constant" datatype="DOUBLE" max="-" min="-" default="-" unit="t m^-3" uri="-"/>
		<Input name="SoilTempArray" description="Current soil temperature per layer" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" default="-" unit="°C" uri="-"/>
		<Input name="rSoilTempArrayRate" description="Current daily soil temperature change per layer" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" default="-" unit="°C/day" uri="-"/>
		<Input name="pSoilLayerDepth" description="Depth to the bottom of each (including added) soil layer" inputtype="variable" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" default="-" unit="m" uri="-"/>
	</Inputs>
	<Outputs>
		<Output name="SoilTempArray" description="Updated soil temperature per layer" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" unit="°C" uri="-"/>
		<Output name="rSoilTempArrayRate" description="Updated daily soil temperature change per layer" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" unit="°C/day" uri="-"/>
		<Output name="pSoilLayerDepth" description="Depth to bottom of each (including added) soil layer (potentially re-initialized)" variablecategory="state" datatype="DOUBLELIST" len="-" max="-" min="-" unit="m" uri="-"/>
	</Outputs>
	<Initialization name="STMPsimCalculator_init" language="cyml" filename="algo/pyx/STMPsimCalculator_init.pyx"/>
	<Function name="_compute_damping_depth" description="Compute damping depth (DD) based on bulk density and water content." language="cyml" type="external" filename="algo/pyx/_compute_damping_depth.pyx"/>
	<Algorithm language="cyml" platform="" filename="algo/pyx/STMPsimCalculator_process.pyx"/>
	<Parametersets>
		<Parameterset name="p_test_STMPsimCalculator_case0" description="Initializes then processes one day and checks SoilTempArray against expected values.">
			<Param name="cSoilLayerDepth">[0.1, 0.5, 1.5]</Param>
			<Param name="cFirstDayMeanTemp">15.0</Param>
			<Param name="cAVT">9.0</Param>
			<Param name="cABD">1.4</Param>
			<Param name="cDampingDepth">6.0</Param>
		</Parameterset>
	</Parametersets>
	<Testsets>
		<Testset name="t_test_STMPsimCalculator_case0" description="Initializes then processes one day and checks SoilTempArray against expected values." parameterset="p_test_STMPsimCalculator_case0">
			<Test name="t_test_STMPsimCalculator_case0">
				<InputValue name="iSoilWaterContent">0.3</InputValue>
				<InputValue name="iSoilSurfaceTemperature">6.0</InputValue>
				<InputValue name="iDoInitialize">0</InputValue>
				<OutputValue name="SoilTempArray">[13.624360856350041, 13.399968504634286, 12.599999999999845, 12.2, 11.4, 10.6, 9.799999999999999, 9.0]</OutputValue>
			</Test>
		</Testset>
	</Testsets>
</ModelUnit>
